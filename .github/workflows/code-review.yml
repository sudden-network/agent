name: code-review

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, edited, synchronize, ready_for_review]
  pull_request_review_comment:
    types: [created, edited]
  issue_comment:
    types: [created, edited]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: false

jobs:
  code-review:
    if: >-
      (github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository) ||
      github.event_name == 'pull_request_review_comment' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    runs-on: ubuntu-latest
    permissions:
      contents: write # apply fixes when requested
      pull-requests: write # inline review comments and replies
      issues: write # PR conversation comments and follow-up issues
      actions: read # resume sessions via artifacts
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run sudden-agent
        uses: sudden-network/agent@v1
        with:
          agent_auth_file: ${{ secrets.CODEX_AUTH_JSON }}
          model: gpt-5.3-codex/xhigh
          resume: true
          prompt: |
            Goals:
            - Help the developer get this change shipped.
            - Enforce correctness, security, and maintainability.

            If the PR is a draft, do not perform a full review.
            In draft mode, only answer direct questions, flag obvious blockers, or ask for missing info.
            If the PR is ready for review (not draft), perform a full review and submit a PR review. Be concise and
            specific.
            Use inline comments for specific issues and propose concrete fixes.
            Do not fix issues you find during review unless the author explicitly asks you to. Only propose fixes.
            If the author asks you to fix issues, apply the changes directly to the PR branch.
            If the branch is behind the base branch, update it and comment to let the author know.
            If the PR description is missing or empty, add a detailed summary.
            Only open follow-up issues when explicitly requested.
            If the PR is ready and there is nothing to add, submit an approving review with a short summary.
